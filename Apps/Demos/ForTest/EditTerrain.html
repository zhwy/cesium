<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Use correct character set. -->
    <meta charset="utf-8" />
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <!-- <script src="https://unpkg.com/@turf/turf@6.3.0/turf.min.js"></script> -->
    <title>地形编辑</title>
    <style>
      @import url(../../../../Build/Cesium/Widgets/widgets.css);

      html,
      body,
      #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        position: relative;
      }

      .check {
        position: absolute;
        top: 0;
        left: 0;
        margin: 1rem;
        z-index: 99;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 0.5rem;
      }
    </style>
  </head>

  <body>
    <div id="cesiumContainer">
      <div class="check">
        <input id="check" type="checkbox" /><label for="check">wireframe</label>
      </div>
    </div>
    <script type="module">
      import * as Cesium from "../../../../Source/Cesium.js";
      window.CESIUM_BASE_URL = "../../../../Source";
      window.Cesium = Cesium;
      Cesium.Ion.defaultAccessToken =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0MjM4NGQ4Yi05MjAzLTQ3NzMtOTZmYS05ZDE1ZWZhYTk3OWMiLCJpZCI6MTEzNTYsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1NTg2ODcwMDJ9.I0-TpqepRcWIVUUI8KrhoSZp-a70sRSRveNLBXOwOto";

      /* eslint-disable */
      var viewer;
      var modelHeight;
      viewer = new Cesium.Viewer("cesiumContainer", {
        terrainProvider: Cesium.createWorldTerrain(),
        imageryProvider: new Cesium.UrlTemplateImageryProvider({
          url:
            "https://t6.tianditu.gov.cn/DataServer?T=img_w&X={x}&Y={y}&L={z}&tk=479045451acc52ebaaccf0b7892201dd",
          maximumLevel: 18,
        }),
      });
      window._viewer = viewer;

      var pos = Cesium.Cartesian3.fromDegrees(120.04939, 29.830674, 650.67);
      var orientation = Cesium.Transforms.headingPitchRollQuaternion(
        pos,
        new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(-45), 0, 0)
      );

      var entity = viewer.entities.add({
        position: pos,
        orientation: orientation,
        model: {
          uri: "/Apps/Demos/Underground/隧道test.glb",
        },
      });
      viewer.zoomTo(entity);

      viewer.imageryLayers.remove(viewer.imageryLayers.get(0));

      viewer.imageryLayers.addImageryProvider(new Cesium.GridImageryProvider());
      viewer.imageryLayers.addImageryProvider(
        new Cesium.TileCoordinatesImageryProvider()
      );

      var ds = new Cesium.GeoJsonDataSource();

      viewer.dataSources.add(ds);

      var terrainProvider = viewer.terrainProvider;
      var quadtree = viewer.scene.globe._surface._tileProvider.quadtree;

      var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
      var positions = [];

      if (terrainProvider._terrainEdits)
        terrainProvider._terrainEdits.push({
          polygon: {
            type: "Feature",
            properties: {},
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [120.03759943211811, 29.828206596956647],
                  [120.0294227936824, 29.83015488912204],
                  [120.03329888076668, 29.83599880632919],
                  [120.03742263195998, 29.836609420200887],
                  [120.03759943211811, 29.828206596956647],
                ],
              ],
            },
          },
          polygonTriangles: [
            {
              type: "Feature",
              properties: {
                a: 698.7808252412018,
                b: 698.7808252412018,
                c: 698.7808252412018,
              },
              geometry: {
                type: "Polygon",
                coordinates: [
                  [
                    [
                      120.0294227936824,
                      29.83015488912204,
                      698.7808252412018,
                      698.7808252412018,
                    ],
                    [120.03329888076668, 29.83599880632919, 698.7808252412018],
                    [120.03463074122898, 29.83208718536156, 698.7808252412018],
                    [
                      120.0294227936824,
                      29.83015488912204,
                      698.7808252412018,
                      698.7808252412018,
                    ],
                  ],
                ],
              },
            },
            {
              type: "Feature",
              properties: {
                a: 698.7808252412018,
                b: 698.7808252412018,
                c: 698.7808252412018,
              },
              geometry: {
                type: "Polygon",
                coordinates: [
                  [
                    [
                      120.03463074122898,
                      29.83208718536156,
                      698.7808252412018,
                      698.7808252412018,
                    ],
                    [120.03329888076668, 29.83599880632919, 698.7808252412018],
                    [120.03742263195998, 29.836609420200887, 698.7808252412018],
                    [
                      120.03463074122898,
                      29.83208718536156,
                      698.7808252412018,
                      698.7808252412018,
                    ],
                  ],
                ],
              },
            },
            {
              type: "Feature",
              properties: {
                a: 698.7808252412018,
                b: 698.7808252412018,
                c: 698.7808252412018,
              },
              geometry: {
                type: "Polygon",
                coordinates: [
                  [
                    [
                      120.0294227936824,
                      29.83015488912204,
                      698.7808252412018,
                      698.7808252412018,
                    ],
                    [120.03463074122898, 29.83208718536156, 698.7808252412018],
                    [120.03759943211811, 29.828206596956647, 698.7808252412018],
                    [
                      120.0294227936824,
                      29.83015488912204,
                      698.7808252412018,
                      698.7808252412018,
                    ],
                  ],
                ],
              },
            },
            {
              type: "Feature",
              properties: {
                a: 698.7808252412018,
                b: 698.7808252412018,
                c: 698.7808252412018,
              },
              geometry: {
                type: "Polygon",
                coordinates: [
                  [
                    [
                      120.03463074122898,
                      29.83208718536156,
                      698.7808252412018,
                      698.7808252412018,
                    ],
                    [120.03742263195998, 29.836609420200887, 698.7808252412018],
                    [120.03759943211811, 29.828206596956647, 698.7808252412018],
                    [
                      120.03463074122898,
                      29.83208718536156,
                      698.7808252412018,
                      698.7808252412018,
                    ],
                  ],
                ],
              },
            },
          ],
        });

      var height = null;

      handler.setInputAction(function (movement) {
        var worldPosition = viewer.scene.pickPosition(movement.position);
        if (Cesium.defined(worldPosition)) {
          var carto = Cesium.Cartographic.fromCartesian(worldPosition);
          if (height == null) height = carto.height;
          positions.push([
            Cesium.Math.toDegrees(carto.longitude),
            Cesium.Math.toDegrees(carto.latitude),
            carto.height,
          ]);
          console.log(carto);
        }
      }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

      handler.setInputAction(function (movement) {
        var worldPosition = viewer.scene.pickPosition(movement.position);
        if (Cesium.defined(worldPosition)) {
          var carto = Cesium.Cartographic.fromCartesian(worldPosition);
          console.log(carto);
          positions.push([
            Cesium.Math.toDegrees(carto.longitude),
            Cesium.Math.toDegrees(carto.latitude),
            carto.height,
          ]);
          if (positions.length > 2) {
            var terrainEdits = terrainProvider._terrainEdits;

            terrainEdits.push(generateTin(positions));

            quadtree._terrainNeedsUpdate = true;

            positions = [];
            height = null;
          }
        }
      }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

      document.getElementById("check").onchange = (e) => {
        viewer.scene.globe._surface.tileProvider._debug.wireframe =
          e.target.checked;
      };

      function generateTin(positions) {
        var points = positions.map((p) => {
          return turf.point([p[0], p[1]], {
            z: p[2],
          });
        });
        var collection = turf.featureCollection(points);
        var tin = turf.tin(collection, "z");
        debugger;
        tin.features.forEach((fea) => {
          var coords = fea.geometry.coordinates[0];
          coords[0].push(fea.properties.a);
          coords[1].push(fea.properties.b);
          coords[2].push(fea.properties.c);
        });

        // 整体边界
        var polygon = turf.convex(collection);

        var promise = ds.load(tin);
        promise.then(() => {
          ds.entities._entities._array.forEach((entity) => {
            var color = Cesium.Color.fromRandom({
              alpha: 0.5,
            });
            var color2 = Cesium.Color.clone(color);
            color2.alpha = 1;
            var pos = entity.polygon.hierarchy.getValue().positions;
            Object.assign(entity.polygon, {
              material: color,
              heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
              outline: false,
              height: 5,
            });
            entity.polyline = {
              positions: pos,
              material: new Cesium.ColorMaterialProperty(color2),
              with: 2,
              depthFailMaterial: new Cesium.ColorMaterialProperty(color2),
            };
          });
          // 整体边界
          //   ds.entities.add({
          //     polyline: {
          //       positions: polygon.geometry.coordinates[0].map((p) =>
          //         Cesium.Cartesian3.fromDegrees(p[0], p[1], positions[0][2] + 5)
          //       ),
          //       material: Cesium.Color.RED,
          //       depthFailMaterial: new Cesium.Color(1, 0, 0, 0.5),
          //     },
          //   });
        });
        // console.log({ polygon, tin, positions });

        return {
          polygon: polygon,
          polygonTriangles: tin.features,
        };
      }
    </script>
  </body>
</html>
